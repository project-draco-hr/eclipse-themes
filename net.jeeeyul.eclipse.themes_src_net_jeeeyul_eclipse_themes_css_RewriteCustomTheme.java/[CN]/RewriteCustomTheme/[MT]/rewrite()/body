{
  try {
    Debug.println("Theme is about to rewrite");
    CSSEngine cssEngine=WidgetElement.getEngine(display);
    ExtendedDocumentCSS documentCSS=(ExtendedDocumentCSS)cssEngine.getDocumentCSS();
    StyleSheet customThemeSheet=findCustomThemeSheet(documentCSS);
    CustomThemeGenerator generator=new CustomThemeGenerator(JThemesCore.getDefault().getPreferenceStore());
    String newCSSContent=generator.generate().toString();
    StyleSheet newSheet=cssEngine.parseStyleSheet(new StringReader(newCSSContent));
    StyleSheetList oldSheetList=documentCSS.getStyleSheets();
    List<StyleSheet> newSheetList=new ArrayList<StyleSheet>();
    for (int i=0; i < oldSheetList.getLength(); i++) {
      StyleSheet oldSheet=oldSheetList.item(i);
      if (oldSheet != customThemeSheet) {
        if (!newSheetList.contains(oldSheet))         newSheetList.add(oldSheet);
      }
 else {
        if (!newSheetList.contains(newSheet))         newSheetList.add(newSheet);
      }
    }
    documentCSS.removeAllStyleSheets();
    for (    StyleSheet each : newSheetList) {
      documentCSS.addStyleSheet(each);
    }
    cssEngine.reapply();
    RangeIndicatorHack.update();
    for (    Shell each : Display.getDefault().getShells()) {
      each.layout(true,true);
    }
    Debug.println("Theme was re-written");
  }
 catch (  Exception e) {
    e.printStackTrace();
  }
}
